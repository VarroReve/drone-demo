## 订单状态相关更新

- [需求文档]([http://172.16.3.1:8091/task-view-365.html])
- [下单流程图]([https://tu97vg.axshare.com/#g=1&p=%E5%BE%85%E6%94%AF%E4%BB%98%E6%B5%81%E7%A8%8B%E5%9B%BE](https://tu97vg.axshare.com/#g=1&p=待支付流程图))

### 订单状态更新

- 定义「订单未支付（Unpaid）」状态，状态值为 `0`
- 新增「订单已关闭（Closed）」状态，状态值为 `-1`
- 新增「订单支付失败（Payment Failed）」状态，状态值为 `-2`

### 订单未支付

一个新创建的订单的默认状态为「订单未支付」

- 若订单 30 分钟内未支付，将被标记为「订单已关闭」

- 若订单进行了支付，但支付失败，将被标记为「订单支付失败」
- 若订单进行了支付，且支付成功，将被标记为「新订单」

### 订单已关闭

- 订单创建成功后，添加一个延时 30 分钟的任务到队列，若 30 分钟内该订单没有被支付，队列会将这个订单状态标记为「订单已关闭」
- 一个用户现在只允许存在一个「未支付」的订单。在支付或关闭这个订单之前，用户不能再创建新订单
- 用户可以手动关闭未支付的订单
- 为符合现在的逻辑，需要写一个脚本 / SQL，将状态为「订单未支付」 的历史订单的状态标记为「订单已关闭」

### 订单支付失败

- 支付失败是指**由服务端行为**引起的交易失败，比如三方接口错误、服务器通讯超时，这时会将订单状态更新为「订单支付失败」。由用户行为引起的交易失败，比如`用户收货地址填写错误`、`用户取消支付`等不会更新订单状态
- 一个订单一但被标记为「订单支付失败」，用户就不能再对这个订单进行`取消订单`，`关闭订单`，`重新支付`等操作，需要联系客服进行人工处理



## 下单流程更新

![流程图](C:\Users\firmoo\AppData\Roaming\Typora\typora-user-images\1574402508104.png)

### 购物车相关

~~移除：订单异步通知成功时清空用户购物车~~

新增：在创建订单成功时就清空用户购物车

### 支付相关

新增：**未支付订单**现在可以「重新支付」，此时会检查订单是否可被重新支付、检查库存、检查优惠券、更新数据表中订单的支付方式

新增：当 [PayPal ](https://developer.paypal.com/docs/classic/ipn/integration-guide/IPNandPDTVariables/?mark=travel+rule?mark=payment_status#buyer-information-variables) 的异步通知的字段 `payment_status` 为 `Failed` 时，将订单状态标记为「订单支付失败」

新增：当 Ocean 的异步通知的字段 `payment_details` 为 `['50001', '50002', '50007', '60001', '60002', '60003', '60004', '60005', '60006', '60007', '60008', '60009', '60010', '60011', '60012', '60013', '60014', '60015', '60016']` 时，将订单状态标记为「订单支付失败」，详见 Ocean 支付错误码

新增：若支付异步通知比较慢，订单被延时任务关闭、标记为「订单已关闭」后才收到异步通知，此时还是会将该订单作为正常订单处理，将订单状态更新为「新订单」

### 订单相关

新增：通过 SQL 将数据库中所有状态为「订单未支付」 的历史订单的状态标记为「订单已关闭」

新增：「订单详情」接口现在会返回更多前端需要的字段，用于重新支付页数据展示

新增：「用户中心 -> 订单列表页」将展示所有状态的订单。但是因为刷新了数据库数据，订单列表中可能会出现大量被关闭的订单，所以订单列表接口会过滤掉状态为「订单已关闭」且创建时间小于「订单待支付」功能上线时间的订单

新增：订单创建成功后，添加一个延时 30 分钟的任务到队列，若 30 分钟内该订单没有被支付，队列会将这个订单状态标记为「订单已关闭」

新增：「用户主动关闭订单」、「记录订单支付失败原因」接口

### 收货地址相关

如果用户收货地址填写错误，在支付时 PayPal 会报错，但此时订单中的收货地址已经是快照，用户无法修改订单中的收货地址

新增：允许用户在「重新支付页面」修改**未支付订单**的收货地址信息（但不可以修改国家和配送方式，因为这样做订单金额会发生变化）

### 库存相关

下单时扣除库存的机制发生了改动，这样做一是为了防止刷单锁库存；二是考虑到有些批发商每次下单会买几百个产品，不能妨碍到批发商下单

~~移除：订单异步通知成功时扣除产品库存数量~~

新增：若订单中产品数量小于等于 `10` ，则在创建订单时，就锁定产品的库存；若这个订单被用户或系统关闭，则退还库存

新增：若订单中产品数量大于 `10` ，则创建订单时不会锁库存，订单被关闭时也不会退还库存，但会在订单异步通知成功时扣除库存

### 优惠券相关

优惠券现在有一些使用限制，一是一美金优惠券风控；二是根据优惠券分类限定优惠券每日可使用次数；三是优惠券本身的使用条件限制。因为「订单待支付」需求会破坏优惠券的使用限制，导致用户使用同一个优惠券反复刷单行为，所以限制了用户下单来回避这个问题

新增：一个用户现在只允许存在一个「未支付」的订单。在支付或关闭这个订单之前，用户不能再创建新订单

新增：用户在使用「重新支付」功能时，会检查优惠券的使用次数

### 虚拟产品相关

~~移除：不论什么情况下，「订单详情页」中的虚拟产品优惠券都会一直展示~~

新增：只有订单支付成功后，「订单详情页」中的虚拟产品优惠券才会展示



## Service 更新

新增：「订单管理 -> 订单列表、订单详情」现在可以查询所有状态的订单