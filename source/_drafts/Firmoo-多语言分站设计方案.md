---
title: Firmoo 多语言分站设计方案
date: 2019-08-22 15:43:16
tags:

---

## 多语言分站面临的技术问题：

1. 文本翻译
2. 用户认证
3. 多个站点间同时提供同一个资源
4. 不同时区下数据的存储、展示
5. 代码与数据库耦合
6. 数据库字段翻译问题
7. 搜索引擎 Sphinx、ElasticSeach 部署问题 
8. 华博是否应区分来自不同站点的数据
9. 多站点代码问题



### 文本翻译：

在 API、Service 项目中，许多返回给用户的提示、插入到数据库的日志没有走语言包，这些提示散布在代码的各个角落，并且有些提示是不支持语言包的（比如 API 项目中不同错误代码对应的提示），如何统一管理这些文案？



#### 用户认证问题：

用户是否可以使用一个账户同时登陆多个分站？还是说同一个用户在多个站点间的数据是完全独立的？



#### 多个站点间提供同一个资源：

比如有这么一个产品，它在多个站点上都可以购买，如何解决只上架一次该产品，就发布到所有的站点（或者只发布到某几个特定的站点）？



#### 时区问题：

```sql
show variables like "%time_zone%";

+------------------+------------+
| Variable_name    | Value      |
+------------------+------------+
| system_time_zone | UTC        |
| time_zone        | US/Pacific |
+------------------+------------+
2 rows in set (0.31 sec)
```

目前线上数据库设定的时区为 UTC+0，API 与 Service 项目时区为 UTC-8（西八区，洛杉矶时区），如何解决不同分站在不同时区下数据的存储、展示问题？



#### 数据库与代码耦合问题：

在 API、Service 项目中都有代码与数据库高度耦合的现象存在，如何解决？



### 数据库字段翻译问题：

目前我们有些这种需求：「Service -> 订单详情页」的所有数据全部全部做中英文翻译，包括存在数据库里的订单日志。

那么分站开设后是否会有这种需求：德语站做德语、英语数据库翻译，西语站做西语、英语数据库翻译。

如果有这种需求，那么如何解决数据库字段翻译问题？



#### 搜索引擎 Sphinx、ElasticSeach 部署问题：

产品搜索使用的引擎 Sphinx 部署在 V1 服务器上，邮件搜索使用的搜索引擎 ElasticSearch 部署在 Service 服务器上。分站使用的搜索引擎该如何部署？



#### 华博是否应区分来自不同站点的数据：

目前华博系统只有一套，华博是否应为多站点做些适应性的升级，或者开多套系统？



### 多站点代码同步问题：

如何做到代码只发布一次，就将功能部署到全部站点上（或只部署到某几个特定站点）？



## 多语言分站的解决方案：

1. 将分站与主站完全分离，使用新的服务器、新的数据库，并 fork 一份主站代码作为分站代码
2. 不分库。在数据库中大部分表上，都加一个 `site_id` 字段，用以区分数据来源
3. 不分库。在数据库中新建一张 `资源 <=> 来源` 的中间表。



## 三种方案如何解决上述的各种问题及难易程度：

### 使用方案  1  解决问题  1：

因为分站有自己的数据库和代码，可以不同过语言包，直接将原文案修改为指定语言文案。

- 难度：低
- 工作量：大
- 预计工时：3 天
- 后期维护成本：高



### 使用方案 2 解决问题 1：

使用语言包可以解决，但会遇到 `并且有些提示是不支持语言包的（比如 API 项目中不同错误代码对应的提示）` 的问题，需要另外考虑解决方案

- 难度：低
- 工作量：大
- 预计工时：3 天
- 后期维护成本：低



### 使用方案 3 解决问题 1：

同方案2



### 使用方案  1  解决问题  2：

如果 `同一个用户在多个站点间的数据是完全独立的`，那么该方案天然支持这种架构。
如果 `用户可以使用一个账户同时登陆多个分站`，那么该方案会遇到较大的困难。

- 难度：待定

- 工作量：待定

- 预计工时：待定

- 后期维护成本：待定

  

### 使用方案  2  解决问题  2：

通过为 `users`、`customers` 相关的数据表添加 `site_id` 字段，可以满足这两种需求。

- 难度：低
- 工作量：中
- 预计工时：API 3 天，Service 不确定（对 Service 里各种统计、邮件发送的功能不熟）
- 后期维护成本：待需求确定



### 使用方案  3  解决问题  2：

通过中间表为各种资源提供 `site_id` 标记，

- 难度：高
- 工作量：中
- 预计工时：API 3 天，Service 不确定（对 Service 里各种统计、邮件发送的功能不熟）
- 后期维护成本：低



### 使用方案  1  解决问题  3：

无合适方案，如果一个产品要上架，需要到各自的后台都上架一次

- 难度：低
- 工作量：低
- 预计工时：无
- 后期维护成本：高



### 使用方案  2  解决问题  3：

可以解决上架一次就同步到多个站点，但存在问题。

比如配件表中有一个 `site_id` 字段表示分站，将 `site_id` 设为 1 表示它属于主站，设为 2 表示它属于西语站，但如果这个配件要同时上架到多个国家就会很麻烦。

可以用 `site_id = 1,2,3` 表示它同时属于多个分站，但这样做会引起 SQL 查询的极大不便和性能下降。 

```sql
+-----------+------------------------------------+----------------+--------------+-----------+
| addons_id | addons_name                        | addons_name_zh | addons_price | site_id   |
+-----------+------------------------------------+----------------+--------------+-----------+
|         1 | Cylindrical Paper Glasses Case     | 圆筒纸盒       | 0.95         | 1         |
|         2 | Wooden Glasses Case                | 木头盒         | 4.95         | 1,2       |
|         3 | Leather Glasses Case               | 棕色皮盒       | 4.99         | 1,2,3     |
|         4 | Microfiber Cloth Lens Cleaning Kit | 裙子镜布       | 1.49         | 2,4       |
|         5 | Lens Cleaning Cloth-snowy forest   | 雪景镜布       | 1.49         | 1,2,3,4,5 |
+-----------+------------------------------------+----------------+--------------+-----------+
```

- 难度：低
- 工作量：高（改造 SQL 查询）
- 预计工时：
- 后期维护成本：高



### 使用方案 3 解决问题  3：

比如中间表的结构长这样：

```mysql
+--------+----------+---------+
| type   | type_id  | site_id |
+--------+----------+---------+
| addons |        2 |       1 |
| addons |        1 |       2 |
| addons |        1 |       1 |
| addons |        3 |       3 |
| users  |  1111111 |       1 |
| users  |  2222222 |       2 |
| orders | 10000000 |       1 |
+--------+----------+---------+
```

意思是：

`user_id = 1111111` 的用户来自站点 1

`user_id = 2222222` 的用户来自站点 2

`addon_id = 2` 的配件属于站点 1

`addon_id = 1` 的配件同时属于站点 1、站点2 





## 三种方案各自的优劣：



### 方案1的优点：
### 方案1的缺点：
### 方案2的优点：
### 方案2的缺点：
### 方案3的优点：
### 方案3的缺点：

