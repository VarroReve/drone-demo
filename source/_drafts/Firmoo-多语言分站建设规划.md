---
title: Firmoo 多语言分站建设规划
date: 2019-08-29 11:06:48
tags:
---



## 后端涉及方面：

1. 框架升级
2. 系统升级
2. 多语言翻译工作台
3. 静态资源翻译
4. 数据库翻译
6. 数据区分来源
7. API 项目支持多语言切换
8. 其他功能

## 预计工时评估

![](https://s2.ax1x.com/2019/08/29/mq0kR0.jpg)

## 框架升级

### Laravel  发行、支持时间

| 版本      | 发布时间            | Bug 修复截止时间   | 安全修复截止时间    |
| --------- | ------------------- | ------------------ | ------------------- |
| 5.0       | 2015 年 2 月 4 日   | 2015 年 8 月 4 日  | 2016 年 2 月 4 日   |
| 5.1 (LTS) | 2015 年 6 月 9 日   | 2017 年 6 月 9 日  | 2018 年 6 月 9 日   |
| 5.2       | 2015 年 12 月 21 日 | 2016 年 6 月 21 日 | 2016 年 12 月 21 日 |
| 5.3       | 2016 年 8 月 23 日  | 2017 年 9 月 23 日 | 2017 年 8 月 23 日  |
| 5.4       | 2017 年 1 月 24 日  | 2017 年 7 月 24 日 | 2018 年 1 月 24 日  |
| 5.5 (LTS) | 2017 年 8 月 30 日  | 2019 年 8 月 30 日 | 2020 年 8 月 30 日  |
| 5.6       | 2018 年 2 月 7 日   | 2018 年 8 月 7 日  | 2019 年 2 月 7 日   |
| 5.7       | 2018 年 9 月 4 日   | 2019 年 3 月 4 日  | 2019 年 9 月 4 日   |
| 5.8       | 2019 年 2 月 26 日  | 2019 年 8 月 26 日 | 2020 年 2 月 26 日  |
| 6.0 (LTS) | 2019 年 9 月 3 日  | 2019 年 9 月 3 日 | 2022 年 9 月 3 日  |

Laravel 框架的 5.2 从发布距今接近 4 年，5.5 超过两年，两者都已停止 BUG 修复。

本次多语言站点建设需要用到高版本的特性和拓展包。借此机会升级框架后，对将来其他需求可以提供更好的技术支持。

### 版本选择

第一种数据库翻译方案拓展包 [dimsav/laravel-translatable](https://packagist.org/packages/dimsav/laravel-translatable) 要求：

>
php: >=7.1.3
illuminate/support: 5.6.*|5.7.*|5.8.*


第二种方案 [spatie/laravel-translatable](https://packagist.org/packages/spatie/laravel-translatable) 要求：

>php: ^7.2
illuminate/database: ~5.8.0
illuminate/support: ~5.8.0


总体上需要 PHP >= 7.2，Laravel >= 5.8，MySQL >= 5.7。

Laravel 6 将于 2019 年 9 月 3 日发布，并且是长期支持版（LTS），理想状态下将 API、Service 升级到 Laravel 6 是最好的选择，但 Laravel 6 有一些向下不兼容的改动，并且 Laravel 的拓展包大部分还没有适配 Laravel 6，建议先将框架升级至 5.8，在大约半年后，再升级至 6.0 以上的版本。

### 预计工时

API 项目的 Laravel 框架从 5.5 升级至 5.8 预计需要 2 天。

Service 项目从 5.2 升级至 5.8 风险和难度很大，除了版本跨度太大，还有就是之前开发人员对框架进行了很多改造，最坏的情况下我可能会把这些改造再改回它原本的样子。计划是 PHP 升级到 7.2 后，先接入 Sentry，将 BUG 改的差不多后，升级至 5.3、上线、改 BUG，再升级至 5.4、上线、改 BUG……直到升级至 5.8。每一个小版本间的升级，都需要遍历整个项目的代码，修复其中不兼容的改动，并且需要对比同版本的官方框架的代码，这个过程预计需要一天，然后观察、修复 Sentry 上的 BUG 大概需要一天。总体上说，Service 从  5.2 升级至 5.8 需要（1 + 1）* 6 = 12 天。



## 系统升级

### PHP

API 项目 PHP 版本为 7.2.10，不需要升级。Service 项目为 5.6.14，需要升级。建议使用软链接的方式，先在服务器上部署 PHP 7.2，再用软链接将 PHP 从 5.6 指向 7.2。

### MySQL

MySQL 5.7 支持了 JSON 字段存储，MySQL 8 增强了 JSON 的操作、速度、查询方式。总体来说用 MySQL 8 更好，不过 MySQL 8 有些大规模的改动，目前的需求也不会有大规模 JSON 操作，所以 MySQL 5.7 够用。

### 预计工时

PHP 升级预计需要 1 天。

MySQL 升级需要的时间不确定，应该可以在 AWS 后台直接升级。

## 多语言翻译工作台

>  之前在涉及到多语言翻译的需求时，工作流大概是这样：
>
> 开发先将代码中需要翻译的资源整理成一个 Excel 表格，里面写好中文版翻译，然后客服部翻译后将英文版对照着填到这个 Excel 表格中，再交给开发，最后开发再把这个表格写回到代码的语言包中。

这个过程中基本是在复制、粘贴，随着多语言需求越来越多，就需要一个翻译工作台解决这个问题。

比如有这么一个功能，开发人员先将需要翻译的中文添加到页面上，之后由翻译人员将英语、西语文案在线翻译。这些数据会保存到数据库的某张翻译表中，最后可以从数据库把这些翻译资源导出为 PHP 语言包文件。

![](https://s2.ax1x.com/2019/08/29/mqia5V.jpg)

目前来说这个工作台只支持生成 PHP 版本的语言包，JS 的语言包还没有合适的生成方案

### 预计工时

搭建工作台需要 1 天。

## 静态资源翻译

### 预计工时

整理、翻译 API 项目的静态资源预计 2 天。

## 数据库翻译

### 数据结构及旧数据处理

数据库翻译首先要处理老数据格式化成支持多语言的存储格式，比如有个 `category_name` 字段，里面直接存了英文版的字符串 ‘sun glasses’，现在需要先写 SQL 把这个字段改成 JSON 字段，在把原有数据格式化成 JSON

```
{
	en: "sun glasses",
	es: ""
}
```



### 后台管理系统支持

比如现在有许多产品需要作翻译，这就需要管理后台支持产品的多语言编辑功能。

V1 项目现在支不支持产品多语言编辑功能，这个我不清楚，如果可能，最好把这个功能放到使用 laravel 5.8 的项目中，比如升级后的 Service

### 预计工时

数据结构及旧数据处理预计 2 天。

后台管理系统支持，这个取决于需求，如果很多地方都需要多语言编辑，那就需要改很多后台功能。

## 数据区分来源

### 数据库数据区分来源

目前有四种方案：

- 直接在每张表中加一个来源字段
- 为每张表新增一个附加表，区分来源
- 使用一张中间表区分来源
- 根据模块使用多张中间表区分来源

### 代码改动

根据不同的数据库数据区分来源方案，在项目中增加区别数据来源的代码。

这个改动可能涉及到 API、Service、V1 三个项目。

### 后台管理系统支持

要对不同来源的数据筛选、统计，就需要改管理后台的代码。

### 预计工时

数据库数据区分来源，如果使用前两种方案，建表、加字段预计需要 2 天，使用后两种方案预计 0.5 天。

代码改动，如果使用前两种方案，会改动到项目较多的地方，预计 4 天，使用后两种方案预计 2 天。

后台管理系统支持，这个取决于需求，如果很多地方都需要区分来源，那就需要改很多后台功能。

## API 项目支持多语言切换

API 项目的某些接口要求在请求头中传入 `language` 字段，这个我计划按照多语言切换的标准做法来改造接口和中间件

### 预计工时

预计 1 天

## 其他功能

一些杂七杂八的、没有被上文提到的需求，作为其他功能。

### 预计工时

取决于需求。